<?xml version="1.0" encoding="UTF-8"?>
<nts:component xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
    <nts:parameter name="warningOnly" value="false"/>
    <action>
        <assert>
            <description value="Confirm that Bundle does not use Burgerservicenummer (BSN) anywhere."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().select(identifier.where(system.toString() = 'http://fhir.nl/fhir/NamingSystem/bsn').where(value.empty())).count() = 0"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that Bundle does not use Burgerservicenummer (BSN) in the self link."/>
            <direction value="response"/>
            <expression value="Bundle.link.url.contains('http://fhir.nl/fhir/NamingSystem/bsn') = false"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that all returned resources except OperationOutcome contain a meta.profile tag."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.where(is(OperationOutcome).not()).where(meta.profile.empty()).empty()"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that all returned resources contain an Resource.id. The only time that a resource does not have an id is when it is being submitted to the server using a create operation: https://www.hl7.org/fhir/STU3/resource-definitions.html#Resource.id "/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.id.count() = Bundle.entry.resource.count()"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that the fullUrl does not disagree with the id in the resource, see http://hl7.org/fhir/stu3/bundle-definitions.html#Bundle.entry.fullUrl"/>
            <direction value="response"/>
            <expression value="Bundle.entry.all($this.fullUrl.endsWith($this.resource.id))"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that the fullUrl is an absolute URL."/>
            <direction value="response"/>
            <expression value="Bundle.entry.fullUrl.all(startsWith('http') or startsWith('urn:oid') or startsWith('urn:uuid'))"/>
        </assert>
    </action>   
    <action>
        <assert>
            <description value="Confirm that literal References (Reference.reference) are an absolute URL, a relative URL or an internal fragment refrene (contained), see: http://hl7.org/fhir/stu3/references.html#literal."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().reference.all(startsWith('http') or startsWith('urn:oid') or startsWith('urn:uuid') or startsWith('#')  or matches('[a-zA-Z]{3,}\/.+') )"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/MedMij:V2019.01_FHIR_IG#Use_of_the_reference_datatype."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(Reference)).all(display.exists())"/>
        </assert>
    </action> 
    <action>
        <assert>
            <description value="Confrim that all CodeableConcept contain a coding.display or a text value, see https://informatiestandaarden.nictiz.nl/wiki/MedMij:V2019.01_FHIR_IG#Use_of_coded_concepts."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(CodeableConcept)).all(coding.display.exists() or text.exists())"/>
        </assert>
    </action>   
    <action>
        <assert>
            <description value="Confirm that all Coding contain a display value, see https://informatiestandaarden.nictiz.nl/wiki/MedMij:V2019.01_FHIR_IG#Use_of_coded_concepts."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().coding.all(display.exists())"/>
        </assert>
    </action>   
    <action>
        <assert>
            <description value="Confirm that the returned Bundle conforms to the base FHIR specification and the resources to the stated profiles in the meta.profile tag."/>
            <direction value="response"/>
            <validateProfileId value="bundle-profile"/>
            <warningOnly value="{$warningOnly}"/>
        </assert>
    </action>
</nts:component>
